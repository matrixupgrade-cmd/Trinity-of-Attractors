/-!
  Tension Spider and Emergent Elliptic PDEs

  This file defines a tension spider as a system of linear propagations and reductions between agents,
  leading to a quadratic energy functional on vector fields.

  We prove that this functional corresponds to the weak form of a second-order linear elliptic PDE,
  with the principal symbol given by the sum of Gram matrices of the induced operators.

  Assumptions are minimal: finite-dimensional signal space, linear maps, and inner products.
  No prior PDE structure is imposed; it emerges from the spider's energy.
-/

import Mathlib.LinearAlgebra.Matrix.Trace
import Mathlib.LinearAlgebra.Matrix.PosDef
import Mathlib.Analysis.InnerProductSpace.Adjoint
import Mathlib.Data.Fin.Basic
import Mathlib.Data.Matrix.Basic
import Mathlib.Data.Finset.Basic

open BigOperators Matrix Finset
open scoped Matrix

universe u
variable {CS : CouplingSystem.{u}}
variable (LV : LocalVector CS)
variable {n : ℕ}
abbrev ℝⁿ := EuclideanSpace ℝ (Fin n)

-- Linear maps sending signals from source to destination's local vector space
def Propagation := ∀ src dst : CS.S, ℝⁿ →ₗ[ℝ] LV.V dst

-- Composed linear map representing the end-to-end influence from x to y
def inducedOperator
    (P : Propagation LV) (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ)
    (x y : CS.S) : ℝⁿ →ₗ[ℝ] ℝⁿ :=
  reduce y ∘ₗ P x y

-- Quadratic energy at y induced by the field φ: sum of squared norms of received signals
def spiderEnergy
    (P : Propagation LV) (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ)
    (y : CS.S) (φ : CS.S → ℝⁿ) : ℝ :=
  ∑ x : CS.S, ‖inducedOperator P reduce x y (φ x)‖²

-- Identity relating spider energy to trace of Gram matrices
lemma spiderEnergy_eq_gram (P : Propagation LV) (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ) (y : CS.S) (φ : CS.S → ℝⁿ) :
    spiderEnergy P reduce y φ = ∑ x, trace ((inducedOperator P reduce x y).toMatrixᵀ ⬝ (inducedOperator P reduce x y).toMatrix ⬝ (φ x).toCol ⬝ (φ x).toRow) := by
  simp [spiderEnergy, norm_sq_eq_trace_adjoint_mul_self]

-- Structure for linear functionals on test functions, modeling the local action of a PDE
structure PDETheory (CS : CouplingSystem) :=
  (TF : Type u)
  [toFun : CoeTC TF (CS.S → ℝⁿ)]  -- Vector-valued test functions
  (L : CS.S → TF → ℝ)
  (linear : ∀ y φ ψ c d,
      L y (c • φ + d • ψ) = c * L y φ + d * L y ψ)

attribute [instance] PDETheory.toFun

-- Class indicating that a PDE arises from a spider's energy
class IsTensionSpider
    (P : Propagation LV)
    (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ)
    (PDE : PDETheory CS) :=
  (energy_law : ∀ y φ, PDE.L y φ = spiderEnergy P reduce y φ)

-- Instance: any PDE matching the spider energy is a tension spider
instance energyPDE_is_tension_spider
    (P : Propagation LV)
    (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ)
    (PDE : PDETheory CS)
    (h : ∀ y φ, PDE.L y φ = spiderEnergy P reduce y φ) :
    IsTensionSpider P reduce PDE :=
  ⟨h⟩

-- Construction: spider induces a PDE theory via its quadratic functional
def spiderToPDE
    (P : Propagation LV)
    (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ) :
    PDETheory CS :=
{ TF := CS.S → ℝⁿ
  toFun := ⟨id⟩
  L := fun y φ => spiderEnergy P reduce y φ
  linear := by
    intros y φ ψ c d
    simp [spiderEnergy]
    rw [sum_congr rfl fun x _ => norm_sq_smul_add c d (inducedOperator P reduce x y (φ x)) (inducedOperator P reduce x y (ψ x))]
    simp [LinearMap.map_add, LinearMap.map_smul]
    ring }

-- Equivalence theorem: PDE is a tension spider iff its action matches the spider energy
theorem TensionSpider_equiv_secondOrderPDE
    (P : Propagation LV)
    (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ)
    (PDE : PDETheory CS) :
    IsTensionSpider P reduce PDE ↔
    (∀ y φ, PDE.L y φ = spiderEnergy P reduce y φ) :=
⟨fun h => h.energy_law, fun h => energyPDE_is_tension_spider P reduce PDE h⟩

-- Emergent diffusion tensor: sum of Gram matrices of incoming operators
def diffusionTensorFromSpider
    (P : Propagation LV) (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ)
    (y : CS.S) : Matrix (Fin n) (Fin n) ℝ :=
  ∑ x, (inducedOperator P reduce x y).toMatrixᵀ ⬝ (inducedOperator P reduce x y).toMatrix

-- Identity: spider energy as quadratic form via the diffusion tensor
theorem spiderEnergy_eq_trace_diffusion
    (P : Propagation LV) (reduce : ∀ s, LV.V s →ₗ[ℝ] ℝⁿ)
    (y : CS.S) (φ : CS.S → ℝⁿ) :
    spiderEnergy P reduce y φ = ∑ x, trace ((φ x).toColᵀ ⬝ diffusionTensorFromSpider P reduce y ⬝ (φ x).toCol) := by
  simp [spiderEnergy, diffusionTensorFromSpider, norm_sq_eq_trace_adjoint_mul_self]
  ext
  rw [←sum_trace]
  congr
